<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="renderer" content="webkit">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>
        ShoJinto 滔滔
    </title>
    
<link rel="stylesheet" href="/libs/highlight/styles/monokai-sublime.css">

    
<link rel="stylesheet" href="/libs/font-awesome/css/font-awesome.min.css">

    
<link rel="stylesheet" href="/css/style.css">

	
	<script>
	var _hmt = _hmt || [];
	(function() {
	  var hm = document.createElement("script");
	  hm.src = "https://hm.baidu.com/hm.js?72885fc2764dfa73d0ab5176af60d0d1";
	  var s = document.getElementsByTagName("script")[0]; 
	  s.parentNode.insertBefore(hm, s);
	})();
	</script>

<meta name="generator" content="Hexo 6.1.0"></head>

<body id="bodyx">
    <div class="hd posts">
    <a href="/index.html"><i class="fa fa-reply replay-btn" aria-hidden="true"></i></a>
    <div class="post-title">
        <p>
            Python-docx-操作word文档实战
        </p>
        <hr>
    </div>
    <div class="post-content">
        <h1 id="Python-docx-操作word文档实战"><a href="#Python-docx-操作word文档实战" class="headerlink" title="Python-docx-操作word文档实战"></a>Python-docx-操作word文档实战</h1><h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><p>公司同时有一堆word版本的合同需要进行续期签订，里面牵涉到诸如：合同到期时间、收费费率之类关键信息需要进行调整。针对一个合同来说手动修改即可，但是有一堆这样的合同要操作。很容易出错并且出现错误也很难排查，为了降低人力成本这里采用python-docx模块来帮助同事完成一系列的重复工作。同事只需要维护合同模板和相应的excle表格即可。</p>
<ul>
<li>excle 存储到期时间，费率收取等信息</li>
<li>docx 合同模板</li>
</ul>
<p>这里采用的是<code>python-docxtpl</code>模块，使用方法详见：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/feifeifeisir/p/14701066.html">https://www.cnblogs.com/feifeifeisir/p/14701066.html</a></p>
<h3 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h3><ol>
<li>根据<code>excel</code>中的信息编写<code>.docx</code>模板文件</li>
<li>从<code>excel</code>中读取关键信息生成更新的内容字典</li>
<li>利用<code>python-docxtpl</code>的<code>rander</code>方法对模板中的关键信息进行替换</li>
<li>保存修改的内容</li>
</ol>
<h3 id="实操"><a href="#实操" class="headerlink" title="实操"></a>实操</h3><p>安装处理模块</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install xlrd python-docxtpl</span><br></pre></td></tr></table></figure>

<p>Excel内容形如：</p>
<p><img src="/../images/image-20220216140801797.png" alt="image-20220216140801797"></p>
<p>使用<code>xlrd</code>读取excle中的内容，代码形如：</p>
<p><img src="/../images/image-20220216141425332.png" alt="image-20220216141425332"></p>
<p>往word文档中插入特殊字符<br>处理特殊字符：应用场景详见<a target="_blank" rel="noopener" href="https://blog.csdn.net/wi162yyxq/article/details/108431881">https://blog.csdn.net/wi162yyxq/article/details/108431881</a></p>
<p>为了实现这个需求我这边可谓是煞费苦心！！！<br>最开始找了<code>python-docx</code>模块根据<a target="_blank" rel="noopener" href="https://blog.csdn.net/wi162yyxq/article/details/108431881">特殊字符处理</a>了解到<code>openXML</code>并找到一些<a target="_blank" rel="noopener" href="https://blog.csdn.net/liuqixuan1994/article/details/104486600/">稍详细描述</a>通过这两篇文章我可以轻松操作word的dom节点，但是还不知道如何将修改后的dom树回写到word的document对象中，因此还是不能完成往word中插入<strong>特殊字符的需求</strong>。好在有强大的Google帮忙，最终找到了一篇关于<a target="_blank" rel="noopener" href="http://jike.in/?qa=1146252/xml-how-can-i-insert-a-checkbox-form-into-a-docx-file-using-python-docx">往word中添加checkbox的博客</a>了解到<code>python-docx</code>模块处理word的逻辑，完成了向word中添加特殊字符的需求。后来又找到一篇<a target="_blank" rel="noopener" href="https://www.shibutan-bloomers.com/python_library_python-docx/2247/">日本朋友写的博客</a>图文并茂简直不要太香！！这里引用一下他的图片以期更直观的理解<code>python-docx</code>模块:<img src="https://www.shibutan-bloomers.com/wp-content/uploads/2021/04/f087c8ef7ec4914ce8af442ffa893eb6-1024x677.png" alt="python-docx中对象的层次结构"></p>
<p><img src="https://www.shibutan-bloomers.com/wp-content/uploads/2021/10/70b6f3266827ddafc897ee4276c69bd5.png" alt="python-docx_Part 2_rev0.2中对象的层次结构"></p>
<p>通过以上资料，我这边往<code>word</code>中添加特殊字符的代码如下:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> docx <span class="keyword">import</span> Document</span><br><span class="line"><span class="keyword">from</span> docx.oxml.shared <span class="keyword">import</span> qn, OxmlElement</span><br><span class="line">doc = Document(<span class="string">&#x27;123.docx&#x27;</span>)</span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">根据python-docx的官方文档:https://python-docx.readthedocs.io/en/latest/api/text.html#paragraph-objects</span></span><br><span class="line"><span class="string">doc &gt; paragraph &gt; run</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">for</span> p <span class="keyword">in</span> doc.paragraphs:</span><br><span class="line">    <span class="comment"># 定位到需要插入特殊字符的位置</span></span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;□&quot;</span> <span class="keyword">in</span> p.text <span class="keyword">and</span> <span class="string">&quot;abc&quot;</span> <span class="keyword">in</span> p.text:</span><br><span class="line">        <span class="comment"># print(p.runs[0].text)</span></span><br><span class="line">        run_id = <span class="number">0</span> <span class="comment"># 因为paragraph包含多个run，这里的标记是对run进行定位</span></span><br><span class="line">        <span class="keyword">for</span> run <span class="keyword">in</span> p.runs:</span><br><span class="line">            <span class="keyword">if</span> <span class="string">&quot;□&quot;</span> <span class="keyword">in</span> run.text:</span><br><span class="line">                tag = p._p[run_id] <span class="comment"># 找到需要被替换的run</span></span><br><span class="line">                <span class="comment"># 利用OxmlElement生成一个特殊字符</span></span><br><span class="line">                right_mark = OxmlElement(<span class="string">&#x27;w:sym&#x27;</span>)</span><br><span class="line">                right_mark.<span class="built_in">set</span>(qn(<span class="string">&#x27;w:font&#x27;</span>), <span class="string">&#x27;Wingdings 2&#x27;</span>)</span><br><span class="line">                right_mark.<span class="built_in">set</span>(qn(<span class="string">&#x27;w:char&#x27;</span>), <span class="string">&#x27;F052&#x27;</span>)</span><br><span class="line">                <span class="comment"># 将特殊字符添加到run中</span></span><br><span class="line">                tag.append(right_mark)</span><br><span class="line">                <span class="comment"># 清理到旧的run，因为已经插入了一个新的run所以这里可以直接清理，以达到替换的效果</span></span><br><span class="line">                run.clear()</span><br><span class="line">            run_id += <span class="number">1</span></span><br><span class="line">doc.save(<span class="string">&#x27;xxxx.docx&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>由于<code>DocxTemplate</code>不能直接读入去内存中的docx文档，因此插入特殊字符和从excel中更新信息两个步骤需要借助中间文档<code>xxxx.docx</code>进行，以及最终合同需要分三个情况生成，因此以上方式显得非常臃肿。那么有没有办法让代码更加干练呢？答案是肯定的。通过查阅资料以上步骤其实可以借助python-docxtpl模块的强大能来来实现，其实都是源于jinja2的模板语法。</p>
<p><em>以下是所有操作的基础</em></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">正常的Jinja <span class="number">2</span>语法只有%的普通标签，而docxtpl的类语法包含%p，%tr，%tc，%r</span><br><span class="line"></span><br><span class="line">%p：段落，即docx.text.paragraph.Paragraph对象</span><br><span class="line"></span><br><span class="line">%tr：表格中的一行，即docx.table._Row对象</span><br><span class="line"></span><br><span class="line">%tc：表格中的一列，即docx.table._Column对象</span><br><span class="line"></span><br><span class="line">%r：段落中的一个片段，即docx.text.run.Run对象</span><br><span class="line"></span><br><span class="line">通过使用这些标记，python-docx-template将真正的Jinja <span class="number">2</span>标记放入文档的XML源代码中的正确位置。</span><br><span class="line"></span><br><span class="line">另外，需注意，这四种标签，起始标签不能在同一行，必须在不同的行上面。</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>代码实现：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">doctmp = DocxTemplate(<span class="string">&#x27;123.docx&#x27;</span>)</span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">根据业务情况，word模板中的jinja2语法如下：</span></span><br><span class="line"><span class="string">&#123;%r if right_mark %&#125; &#123;&#123; right_mark &#125;&#125;&#123;%r endif %&#125;&#123;% if not right_mark %&#125; □&#123;% endif %&#125;</span></span><br><span class="line"><span class="string">参考：</span></span><br><span class="line"><span class="string">https://www.cnblogs.com/feifeifeisir/p/14701066.html</span></span><br><span class="line"><span class="string">https://docxtpl.readthedocs.io/en/latest/#jinja2-like-syntax</span></span><br><span class="line"><span class="string">因为合同分为主副两份，根据情况最终生成的合同会有如下情况：</span></span><br><span class="line"><span class="string">    1. 主副</span></span><br><span class="line"><span class="string">    2. 主</span></span><br><span class="line"><span class="string">    3. 副</span></span><br><span class="line"><span class="string">因此，合同模板大致结构如：</span></span><br><span class="line"><span class="string">    &#123;% if main %&#125; </span></span><br><span class="line"><span class="string">    主合同内容</span></span><br><span class="line"><span class="string">    &#123;% endif %&#125;</span></span><br><span class="line"><span class="string">    &#123;% if secondary %&#125; </span></span><br><span class="line"><span class="string">    副合同内容 </span></span><br><span class="line"><span class="string">    &#123;% endif %&#125;</span></span><br><span class="line"><span class="string">要如何生成合同内容只需要传递相应的内容给合同模板即可</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line">context = &#123;</span><br><span class="line">    <span class="string">&quot;main&quot;</span>: <span class="literal">True</span>,</span><br><span class="line">    <span class="string">&quot;secondary&quot;</span>: <span class="literal">False</span>,</span><br><span class="line">    <span class="string">&quot;right_mark&quot;</span>: <span class="string">&#x27;&lt;w:sym w:font=&quot;Wingdings 2&quot; w:char=&quot;F052&quot;/&gt;&#x27;</span>, <span class="comment"># word中的“对号”，利用 docxtpl中的 &#123;%r 专属标签实现</span></span><br><span class="line">&#125;</span><br><span class="line">doctmp.render(context)</span><br><span class="line">doctmp.save(<span class="string">&quot;a123.docx&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;done.&#x27;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

    </div>

    
        <hr class="fhr">
        <div id="vcomments"></div>
    
</div>
    <div class="footer" id="footer">
    <p>Copyright © 2020 <a class="flink" target="_blank" rel="noopener" href="https://hexo.io">Hexo</a>-<a class="flink" target="_blank" rel="noopener" href="https://github.com/sanjinhub/hexo-theme-geek">Geek</a>.
        <label class="el-switch el-switch-green el-switch-sm" style="vertical-align: sub;">
            <input type="checkbox" name="switch" id="update_style">
            <span class="el-switch-style"></span>
        </label>
<!--         <script type="text/javascript">
        var cnzz_protocol = (("https:" == document.location.protocol) ? "https://" : "http://");
        document.write(unescape("%3Cspan id='cnzz_stat_icon_1278548644'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "v1.cnzz.com/stat.php%3Fid%3D1278548644%26show%3Dpic1' type='text/javascript'%3E%3C/script%3E"));
        </script> -->
    </p>
</div>
<input type="hidden" id="web_style" value="black">
<input type="hidden" id="valine_appid" value="sBc8tGpQjtwbggV9gG8iVW1b-gzGzoHsz">
<input type="hidden" id="valine_appKey" value="95egYUoH984IghLnWsu0eyA6">

<script src="/libs/jquery.min.js"></script>


<script src="/libs/highlight/highlight.pack.js"></script>

<script src='//cdn.jsdelivr.net/npm/valine@1.3.10/dist/Valine.min.js'></script>

<script src="/js/js.js"></script>

<style type="text/css">
.v * {
    color: #698fca;
}

.v .vlist .vcard .vhead .vsys {
    color: #3a3e4a;
}

.v .vlist .vcard .vh .vmeta .vat {
    color: #638fd5;
}

.v .vlist .vcard .vhead .vnick {
    color: #6ba1ff;
}

.v a {
    color: #8696b1;
}

.v .vlist .vcard .vhead .vnick:hover {
    color: #669bfc;
}
</style>
</body>

</html>